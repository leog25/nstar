<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>N*</title>

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <script>
        AFRAME.registerComponent('billboard', {
            init: function() {
                this.camera = document.querySelector('#camera');
            },
            tick: function() {
                if (this.camera) {
                    var cameraPosition = this.camera.object3D.getWorldPosition(new THREE.Vector3());
                    var thisPosition = this.el.object3D.getWorldPosition(new THREE.Vector3());
                    this.el.object3D.lookAt(cameraPosition);
                }
            }
        });

        AFRAME.registerComponent('morse-pulse', {
            schema: {
                text: {type: 'string', default: 'NORTH STAR'}
            },
            init: function() {
                this.morseCode = {
                    'N': '-.', 'O': '---', 'R': '.-.', 'T': '-', 'H': '....',
                    'S': '...', 'A': '.-', ' ': ' '
                };
                
                this.dotDuration = 400;
                this.dashDuration = 1200;
                this.gapDuration = 300;
                this.letterGapDuration = 800;
                this.wordGapDuration = 1800;
                
                this.sequence = this.textToMorseSequence(this.data.text);
                this.currentIndex = 0;
                this.currentTime = 0;
                
                this.material = this.el.getAttribute('material');
            },
            
            textToMorseSequence: function(text) {
                var sequence = [];
                var words = text.toUpperCase().split(' ');
                
                for (var w = 0; w < words.length; w++) {
                    var word = words[w];
                    for (var i = 0; i < word.length; i++) {
                        var char = word[i];
                        var morse = this.morseCode[char];
                        if (morse) {
                            for (var j = 0; j < morse.length; j++) {
                                var symbol = morse[j];
                                if (symbol === '.') {
                                    sequence.push({type: 'dot', duration: this.dotDuration});
                                } else if (symbol === '-') {
                                    sequence.push({type: 'dash', duration: this.dashDuration});
                                }
                                if (j < morse.length - 1) {
                                    sequence.push({type: 'gap', duration: this.gapDuration});
                                }
                            }
                            if (i < word.length - 1) {
                                sequence.push({type: 'gap', duration: this.letterGapDuration});
                            }
                        }
                    }
                    if (w < words.length - 1) {
                        sequence.push({type: 'gap', duration: this.wordGapDuration});
                    }
                }
                
                sequence.push({type: 'gap', duration: 2000});
                
                return sequence;
            },
            
            tick: function(time, timeDelta) {
                this.currentTime += timeDelta;
                
                var current = this.sequence[this.currentIndex];
                if (!current) {
                    this.currentIndex = 0;
                    this.currentTime = 0;
                    return;
                }
                
                if (this.currentTime >= current.duration) {
                    this.currentTime = 0;
                    this.currentIndex = (this.currentIndex + 1) % this.sequence.length;
                    current = this.sequence[this.currentIndex];
                }
                
                var progress = this.currentTime / current.duration;
                
                var fadeProgress;
                if (current.type === 'dot' || current.type === 'dash') {
                    fadeProgress = Math.sin(progress * Math.PI);
                    
                    fadeProgress = fadeProgress * fadeProgress;
                    
                    var opacity = 0.1 + (fadeProgress * 0.3);
                    var scale = 1.0 + (fadeProgress * 0.1);
                    
                    this.el.setAttribute('material', 'opacity', opacity);
                    this.el.setAttribute('scale', scale + ' ' + scale + ' ' + scale);
                } else {
                    this.el.setAttribute('material', 'opacity', 0.05);
                    this.el.setAttribute('scale', '1 1 1');
                }
            }
        });
    </script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <a-scene id="vr-scene" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" background="color: #000000">
        <a-entity id="camera-rig" position="0 0 0">
            <a-camera
                id="camera"
                look-controls="magicWindowTrackingEnabled: true; touchEnabled: false"
                wasd-controls="enabled: false"
                position="0 0 0">
            </a-camera>
        </a-entity>

        <a-sky color="#000000"></a-sky>

        <a-entity id="north-star"
                  position="0 20 -2"
                  light="type: point; intensity: 0.5; distance: 50; color: #FFFFFF">
            <a-entity billboard>
                <a-cylinder radius="0.015" height="0.4" 
                            material="color: #FFFFFF; emissive: #FFFFFF; emissiveIntensity: 2; shader: flat"></a-cylinder>
                <a-cylinder radius="0.015" height="0.4" rotation="0 0 90"
                            material="color: #FFFFFF; emissive: #FFFFFF; emissiveIntensity: 2; shader: flat"></a-cylinder>
                <a-cylinder radius="0.015" height="0.32" rotation="0 0 45"
                            material="color: #FFFFFF; emissive: #FFFFFF; emissiveIntensity: 2; shader: flat"></a-cylinder>
                <a-cylinder radius="0.015" height="0.32" rotation="0 0 -45"
                            material="color: #FFFFFF; emissive: #FFFFFF; emissiveIntensity: 2; shader: flat"></a-cylinder>
                <a-sphere radius="0.04"
                          material="color: #FFFFFF; emissive: #FFFFFF; emissiveIntensity: 2; shader: flat"></a-sphere>
            </a-entity>
            
            <a-entity geometry="primitive: sphere; radius: 0.2"
                      material="color: #FFFFFF; opacity: 0.3; shader: flat"></a-entity>
            <a-entity geometry="primitive: sphere; radius: 0.3"
                      material="color: #FFFFFF; opacity: 1;"
                      morse-pulse="text: NORTH STAR"></a-entity>
        </a-entity>

        <a-entity id="cardinal-markers">
            <a-text value="S" position="0 0 10" color="#00FF00" align="center" width="10"></a-text>

            <a-text value="E" position="10 0 0" color="#0088FF" align="center" width="10"></a-text>

            <a-text value="W" position="-10 0 0" color="#FFFF00" align="center" width="10"></a-text>
        </a-entity>

        <a-entity id="reference-stars">
            <a-sphere position="5 10 -15" radius="0.02" color="#CCCCCC" opacity="0.7"></a-sphere>
            <a-sphere position="-8 5 -10" radius="0.02" color="#CCCCCC" opacity="0.7"></a-sphere>
            <a-sphere position="10 -5 -20" radius="0.02" color="#CCCCCC" opacity="0.7"></a-sphere>
            <a-sphere position="-15 15 -25" radius="0.02" color="#CCCCCC" opacity="0.7"></a-sphere>
            <a-sphere position="3 -10 -12" radius="0.02" color="#CCCCCC" opacity="0.7"></a-sphere>
        </a-entity>

        <a-entity id="orientation-grid" visible="true">
            <a-entity geometry="primitive: ring; radiusInner: 9.9; radiusOuter: 10"
                      material="color: #333333; opacity: 0.3"
                      rotation="0 0 0"
                      position="0 0 0"></a-entity>
            <a-entity geometry="primitive: ring; radiusInner: 9.9; radiusOuter: 10"
                      material="color: #333333; opacity: 0.3"
                      rotation="90 0 0"
                      position="0 0 0"></a-entity>
            <a-entity geometry="primitive: ring; radiusInner: 9.9; radiusOuter: 10"
                      material="color: #333333; opacity: 0.3"
                      rotation="0 90 0"
                      position="0 0 0"></a-entity>
        </a-entity>
    </a-scene>

    <script src="app.js"></script>
</body>
</html>